<!DOCTYPE html>
<html lang="en">
  <head>
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
        "three": "https://unpkg.com/three@0.154.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.154.0/examples/jsm/"
        }
    }
    </script>
    <meta charset="UTF-8" />
    <title>Ciallo</title>
    <style>
			body { margin: 0; }
		</style>
  </head>
  <body>
    <script id="vertexShader" type="x-shader/x-vertex">
      precision mediump float;
      precision mediump int;
      
      uniform mat4 modelViewMatrix;
      uniform mat4 projectionMatrix;
      
      in vec2 position0;
      in float radius0;
      in vec2 position1;
      in float radius1;
      
      out vec2 p;
      out float r;
      flat out vec2 p0;
      flat out float r0;
      flat out vec2 p1;
      flat out float r1;
      
      void main()	{
          vec2 tangent = normalize(position1 - position0);
          vec2 normal = vec2(-tangent.y, tangent.x);
        
          vec2[] offsetSigns = vec2[](
              vec2(-1.0, -1.0),
              vec2(-1.0, 1.0), 
              vec2(1.0,  1.0),
              vec2(1.0,  -1.0));
          vec2 offsetSign = offsetSigns[gl_VertexID];
      
          vec2[] polylineVertexPositions = vec2[](
              position0,
              position0,
              position1,
              position1);
          vec2 pos = polylineVertexPositions[gl_VertexID];
      
          vec4 radiuses = vec4(
              radius0, 
              radius0, 
              radius1, 
              radius1);
          float radius = radiuses[gl_VertexID];
          r = radius;
          r0 = radius0;
          r1 = radius1;
      
          vec2 trapzoidVertexPosition = pos + 
              offsetSign.x * radius * tangent + 
              offsetSign.y * radius * normal;
          p = trapzoidVertexPosition;
          p0 = position0;
          p1 = position1;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(trapzoidVertexPosition, 0.0, 1.0);
      }
		</script>

    <script id="fragmentShader" type="x-shader/x-fragment">
      precision mediump float;
      precision mediump int;
      
      in vec2 p;
      in float r;
      flat in vec2 p0;
      flat in float r0;
      flat in vec2 p1;
      flat in float r1;
      
      out vec4 outColor;
      
      void main()	{
          vec2 tangent = normalize(p1 - p0);
          vec2 normal = vec2(-tangent.y, tangent.x);
      
          float len = distance(p1, p0);
          vec2 pLocal = vec2(dot(p-p0, tangent), dot(p-p0, normal));
          vec2 p0Local = vec2(0, 0);
          vec2 p1Local = vec2(len, 0);
      
          float d0 = distance(p, p0);
          float d1 = distance(p, p1);

          if(pLocal.x < 0.0 && d0 > r){
              discard;
          }
          if(pLocal.x > len && d1 > r){
              discard;
          }
      
          outColor = vec4(1.0, 1.0, 1.0, 1.0);
      }
		</script>

    <script type="module" src="./main.js"></script>
  </body>
</html>